-- IMPORTANT:
--
-- This file was generated by concatenating the three other .sql files together. It can be
-- used for testing, but the separate SQL sequences will be necessary if the Security Master
-- and Position Master need to be installed in different databases.
--
-- Please do not modify it - modify the originals and recreate this using 'ant create-db-sql'.



-- No upgrade operations required on COMMON
 

-- Security master upgrade from patch_1

ALTER TABLE sec_identifier_association
  ALTER validStartDate TYPE TIMESTAMP,
  ALTER validEndDate  TYPE TIMESTAMP;

ALTER TABLE sec_equity
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP,
  ADD shortName VARCHAR(255);

ALTER TABLE sec_option
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP,
  ALTER expiry TYPE TIMESTAMP,
  ADD expiry_accuracy SMALLINT NOT NULL DEFAULT 3,
  ADD payment DOUBLE PRECISION,
  ADD lowerbound DOUBLE PRECISION,
  ADD upperbound DOUBLE PRECISION,
  ADD choose_date TIMESTAMP,
  ADD choose_zone VARCHAR(50),
  ADD underlyingstrike DOUBLE PRECISION,
  ADD underlyingexpiry_date TIMESTAMP,
  ADD underlyingexpiry_accuracy SMALLINT,
  ADD reverse BOOL; 
ALTER TABLE sec_option
  ALTER expiry_accuracy DROP DEFAULT;
ALTER TABLE sec_option RENAME expiry TO expiry_date;

ALTER TABLE sec_bond
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP,
  ALTER maturity TYPE TIMESTAMP,
  ALTER announcementdate TYPE TIMESTAMP,
  ALTER interestaccrualdate TYPE TIMESTAMP,
  ALTER settlementdate TYPE TIMESTAMP,
  ALTER firstcoupondate TYPE TIMESTAMP,
  ADD maturity_accuracy SMALLINT NOT NULL DEFAULT 3,
  ADD announcement_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD interestaccrual_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD settlement_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD firstcoupon_zone VARCHAR(50) NOT NULL DEFAULT 'UTC';
ALTER TABLE sec_bond RENAME maturity TO maturity_date;
ALTER TABLE sec_bond RENAME announcementdate TO announcement_date;
ALTER TABLE sec_bond RENAME interestaccrualdate TO interestaccrual_date;
ALTER TABLE sec_bond RENAME settlementdate TO settlement_date;
ALTER TABLE sec_bond RENAME firstcoupondate TO firstcoupon_date;
ALTER TABLE sec_bond
  ALTER maturity_accuracy DROP DEFAULT,
  ALTER announcement_zone DROP DEFAULT,
  ALTER interestaccrual_zone DROP DEFAULT,
  ALTER settlement_zone DROP DEFAULT,
  ALTER firstcoupon_zone DROP DEFAULT;

ALTER TABLE sec_future
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP,
  ALTER expiry TYPE TIMESTAMP,
  ADD expiry_accuracy SMALLINT NOT NULL DEFAULT 3;
ALTER TABLE sec_future RENAME expiry TO expiry_date;
ALTER TABLE sec_future
  ALTER expiry_accuracy DROP DEFAULT;

ALTER TABLE sec_futurebundle
  ALTER startDate TYPE TIMESTAMP,
  ALTER endDate TYPE TIMESTAMP;

ALTER TABLE sec_cash
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP;

ALTER TABLE sec_fra
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP,
  ALTER startDate TYPE TIMESTAMP,
  ALTER endDate TYPE TIMESTAMP,
  ADD start_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD end_zone VARCHAR(50) NOT NULL DEFAULT 'UTC';
ALTER TABLE sec_fra RENAME startDate TO start_date;
ALTER TABLE sec_fra RENAME endDate TO end_date;
ALTER TABLE sec_fra
  ALTER start_zone DROP DEFAULT,
  ALTER end_zone DROP DEFAULT;

ALTER TABLE sec_swap
  ALTER effectiveDateTime TYPE TIMESTAMP,
  ALTER lastModifiedDateTime TYPE TIMESTAMP,
  ALTER tradedate TYPE TIMESTAMP,
  ALTER effectivedate TYPE TIMESTAMP,
  ALTER maturitydate TYPE TIMESTAMP,
  ALTER forwardstartdate TYPE TIMESTAMP,
  ADD trade_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD effective_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD maturity_zone VARCHAR(50) NOT NULL DEFAULT 'UTC',
  ADD forwardstart_zone VARCHAR(50);
ALTER TABLE sec_swap RENAME tradedate TO trade_date;
ALTER TABLE sec_swap RENAME effectivedate TO effective_date;
ALTER TABLE sec_swap RENAME maturitydate TO maturity_date;
ALTER TABLE sec_swap RENAME forwardstartdate TO forwardstart_date;
ALTER TABLE sec_swap
  ALTER trade_zone DROP DEFAULT,
  ALTER effective_zone DROP DEFAULT,
  ALTER maturity_zone DROP DEFAULT,
  ALTER forwardstart_zone DROP DEFAULT;
UPDATE sec_swap SET forwardstart_zone='UTC' WHERE forwardstart_date IS NOT NULL;

-- Position master upgrade from patch_1

drop table pos_securitykey;
drop table pos_position;
drop table pos_nodetree;
drop table pos_node;
drop table pos_portfolio;

-- design has two documents
--  portfolio and tree of nodes (nested set model)
--  position and associated security key
-- bitemporal versioning exists at the document level
-- each time a document is changed, a new row is written
-- with only the end instant being changed on the old row

create sequence pos_master_seq
    start with 1000 increment by 1 no cycle;
-- "as bigint" required by Derby, not accepted by Postgresql

create table pos_portfolio (
    id bigint not null,
    oid bigint not null,
    ver_from_instant timestamp not null,
    ver_to_instant timestamp not null,
    corr_from_instant timestamp not null,
    corr_to_instant timestamp not null,
    name varchar(255) not null,
    primary key (id),
    constraint pos_ck_port_ver_order check (ver_from_instant <= ver_to_instant),
    constraint pos_ck_port_corr_order check (corr_from_instant <= corr_to_instant)
);

create table pos_node (
    id bigint not null,
    oid bigint not null,
    portfolio_id bigint not null,
    parent_node_id bigint,
    depth int,
    tree_left bigint not null,
    tree_right bigint not null,
    name varchar(255),
    primary key (id),
    constraint pos_fk_node2portfolio foreign key (portfolio_id) references pos_portfolio (id),
    constraint pos_fk_node2parentnode foreign key (parent_node_id) references pos_node (id)
);
-- pos_node is fully dependent of pos_portfolio
-- parent_node_id is an optimization (tree_left/tree_right hold all the tree structure)
-- depth is an optimization (tree_left/tree_right hold all the tree structure)

create table pos_position (
    id bigint not null,
    oid bigint not null,
    portfolio_oid bigint not null,
    parent_node_oid bigint not null,
    ver_from_instant timestamp not null,
    ver_to_instant timestamp not null,
    corr_from_instant timestamp not null,
    corr_to_instant timestamp not null,
    quantity decimal(31,8) not null,
    primary key (id),
    constraint pos_ck_posi_ver_order check (ver_from_instant <= ver_to_instant),
    constraint pos_ck_posi_corr_order check (corr_from_instant <= corr_to_instant)
);
-- portfolio_oid is an optimization

create table pos_securitykey (
    id bigint not null,
    position_id bigint not null,
    id_scheme varchar(255) not null,
    id_value varchar(255) not null,
    primary key (id),
    constraint pos_fk_securitykey2position foreign key (position_id) references pos_position (id)
);
-- pos_securitykey is fully dependent of pos_position


