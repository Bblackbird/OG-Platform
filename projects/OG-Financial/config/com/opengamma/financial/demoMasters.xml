<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>

  <!-- Property file configuration -->
  <bean id="demoMastersProperties" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders" value="true" />
    <property name="location">
      <value>classpath:demoMasters-${opengamma.platform.runmode}.properties</value>
    </property>
  </bean>
  
  <!-- Active MQ -->
  <bean id="activeMQConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
    <constructor-arg value="${activeMQ.brokerURL}" />
    <property name="WatchTopicAdvisories" value="false" /> <!-- IGN-94 -->
  </bean>
  <bean id="jmsConnectionFactory" class="org.apache.activemq.pool.PooledConnectionFactory" destroy-method="stop"> 
    <constructor-arg ref="activeMQConnectionFactory"/>
  </bean>
  <bean id="jmsConnector" class="com.opengamma.util.jms.JmsConnectorFactoryBean">
    <property name="name" value="Masters"/>
    <property name="connectionFactory" ref="jmsConnectionFactory"/>
  </bean>

  <bean id="abstractDbConnector" class="com.opengamma.util.db.DbConnectorFactoryBean" abstract="true">
    <property name="transactionIsolationLevelName" value="ISOLATION_READ_COMMITTED" />
    <property name="transactionPropagationBehaviorName" value="PROPAGATION_REQUIRED" />
  </bean>

  <bean id="cacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">
    <property name="shared" value="true"/>
  </bean>

  <!-- A global Fudge context configured with all of the relevant builders --> 
  <bean id="fudgeContext" class="com.opengamma.util.fudgemsg.OpenGammaFudgeContext" factory-method="getInstance" />
  
  <!-- ================================================================== -->
  <!--  Remote masters -->
  <bean class="com.opengamma.financial.spring.ComponentRepositoryBeanPostProcessor" />
  <!--alias name="sharedMarketDataSnapshotSource" alias="sharedSnapshotSource" />
  <alias name="sharedRepositoryConfigurationSource" alias="demoFunctionRepositoryConfiguration" /-->

  <!-- Sources -->
  <bean id="sharedExchangeSource" class="com.opengamma.financial.spring.ExchangeSourceFactoryBean">
    <property name="exchangeMaster" ref="centralExchangeMaster" />
  </bean>
  <bean id="sharedHolidaySource" class="com.opengamma.financial.spring.HolidaySourceFactoryBean">
    <property name="holidayMaster" ref="centralHolidayMaster"/>
  </bean>
  <bean id="sharedSnapshotSource" class="com.opengamma.financial.spring.MarketDataSnapshotSourceFactoryBean">
    <property name="snapshotMaster" ref="centralMarketDataSnapshotMaster"/>
    <property name="cacheManager" ref="cacheManager" />
  </bean>
  <bean id="sharedSecuritySource" class="com.opengamma.financial.spring.FinancialSecuritySourceFactoryBean">
    <property name="securityMaster" ref="centralSecurityMaster" />
    <property name="cacheManager" ref="cacheManager" />
  </bean>
  <bean id="sharedPositionSource" class="com.opengamma.financial.spring.PositionSourceFactoryBean">
    <property name="portfolioMaster" ref="centralPortfolioMaster" />
    <property name="positionMaster" ref="centralPositionMaster" />
    <property name="cacheManager" ref="cacheManager" />
  </bean>
  <bean id="sharedHistoricalTimeSeriesSource" class="com.opengamma.financial.spring.HistoricalTimeSeriesSourceFactoryBean">
    <property name="historicalTimeSeriesMaster" ref="centralHistoricalTimeSeriesMaster"/>
    <property name="cacheManager" ref="cacheManager" />
    <property name="configSource" ref="sharedConfigSource"/>
  </bean>

  <!-- Config loaders, should be commented out most of the time -->
  <!-- bean class="com.opengamma.financial.spring.ConfigMasterPopulatorsFactoryBean">
    <property name="configMaster" ref="centralConfigMaster" />
    <property name="yieldCurve" value="true" />
    <property name="currencyMatrix" value="true" />
    <property name="swaptionVolatilitySurface" value="true" />
    <property name="irFutureOptionSurface" value="true" />
    <property name="fxOptionVolatilitySurface" value="true" />
    <property name="equityOptionSurface" value="true" />
    <property name="volatilityCube" value="true" />
  </bean-->

  <!-- ================================================================== -->
  <!-- Batch -->
  <bean id="batchDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
    <property name="driverClassName" value="${opengamma.overnight-batch.jdbc.driver}" />
    <property name="url" value="${opengamma.overnight-batch.jdbc.url}" />
    <property name="username" value="${opengamma.overnight-batch.jdbc.username}" />
    <property name="password" value="${opengamma.overnight-batch.jdbc.password}" />
  </bean>
  <bean id="batchDbConnector" parent="abstractDbConnector">
    <property name="name" value="Batch"/>
    <property name="dataSource" ref="batchDataSource"/>
    <property name="dialectName" value="${opengamma.overnight-batch.db.dbdialect}"/>
    <property name="allowHibernateThreadBoundSession" value="true"/>
    <property name="hibernateMappingFiles">
      <list>
        <bean class="com.opengamma.masterdb.batch.HibernateBatchDbFiles"/>
      </list> 
    </property>
  </bean>
  <bean id="dbBatchMaster" class="com.opengamma.masterdb.batch.DbBatchMaster">
    <constructor-arg ref="batchDbConnector"/>  	
  </bean>

  <!-- ================================================================== -->
  <!-- Function configuration -->
  <bean id="demoFunctionRepositoryConfiguration" class="com.opengamma.engine.function.config.CombiningRepositoryConfigurationSource">
    <constructor-arg>
      <list>
        <bean class="com.opengamma.web.spring.DemoStandardFunctionConfiguration" />
        <bean class="com.opengamma.web.spring.DemoCurveFunctionConfiguration">
          <property name="configMaster" ref="centralConfigMaster" />
          <property name="conventionBundleSource" ref="sharedConventionBundleSource" />
        </bean>
        <bean class="com.opengamma.web.spring.DemoSurfaceFunctionConfiguration">
          <property name="configMaster" ref="centralConfigMaster" />
        </bean>
       </list>
    </constructor-arg>
  </bean>

</beans>
