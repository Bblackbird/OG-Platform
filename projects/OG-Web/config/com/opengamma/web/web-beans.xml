<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
    http://www.springframework.org/schema/beans  http://www.springframework.org/schema/beans/spring-beans.xsd">

  <!-- Property file configuration -->
  <bean id="beansProperties" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders" value="true" />
    <property name="locations">
      <list>
        <value>classpath:com/opengamma/web/engine-spring.properties</value>
      </list>
    </property>
  </bean>
  
  <!-- Bundle Property file configuration -->
  <bean id="bundleProperties" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders" value="true" />
    <property name="location" value="classpath:com/opengamma/web/bundle.properties"/>
  </bean>

  <!-- View processor service -->
  <bean id="viewProcessorRestBean" class="com.opengamma.financial.view.rest.RestViewProcessorFactoryBean">
    <property name="viewProcessor" ref="demoViewProcessor" />
    <property name="jmsConnector" ref="standardJmsConnector" />
    <property name="fudgeContext" ref="standardFudgeContext" />
    <property name="executorService" ref="scheduler" />
  </bean>
  <bean id="availableOutputsRestBean" class="com.opengamma.financial.view.rest.AvailableOutputsService">
    <constructor-arg ref="demoAvailableOutputsProvider" />
    <constructor-arg ref="standardFudgeContext" />
  </bean>
  <bean id="dependencyGraphDebugRestBean" class="com.opengamma.financial.depgraph.rest.DependencyGraphBuilderService">
    <constructor-arg ref="standardFudgeContext" />
    <property name="underlying">
      <bean class="com.opengamma.financial.depgraph.rest.DependencyGraphBuilderResourceContextBean">
        <property name="compiledFunctionService" ref="demoFunctionCompilation" />
        <property name="marketDataProviderResolver" ref="standardMarketDataProviderResolver" />
        <property name="computationTargetResolver" ref="demoTargetResolver" />
        <property name="functionResolver" ref="demoFunctionResolver" />
      </bean>
    </property>
  </bean>

  <!-- Snapshotter service -->
  <bean id="snapshotterRest" class="com.opengamma.financial.marketdatasnapshot.rest.MarketDataSnapshottersResource">
    <constructor-arg name="processors" ref="viewProcessorRestBean" />
    <constructor-arg name="volatilityCubeDefinitionSource" ref="combinedVolatilityCubeDefinitionSource" />
  </bean>

  <!-- Function repository configuration -->
  <bean id="functionRepositoryRestBean" class="com.opengamma.financial.function.rest.DataFunctionRepositoryResource">
    <constructor-arg>
      <bean factory-bean="demoFunctionCompilation" factory-method="getFunctionRepository" />
    </constructor-arg>
  </bean>
  
  <!-- Ad hoc batches -->
  <bean id="adHocBatchRestBean" class="com.opengamma.financial.batch.AdHocBatchDbManagerService">
    <constructor-arg ref="sharedBatchMaster" />
    <constructor-arg ref="standardFudgeContext" />
  </bean>

  <!-- Users resource context -->
  <bean id="usersResourceContext" class="com.opengamma.financial.user.rest.UsersResourceContext">
    <property name="fudgeContext" ref="standardFudgeContext" />
    <property name="userPortfolioMaster" ref="userPortfolioMaster" />
    <property name="userPositionMaster" ref="userPositionMaster" />
    <property name="userSecurityMaster" ref="userSecurityMaster" />
    <property name="userViewDefinitionRepository" ref="userViewDefinitionRepository" />
    <property name="userInterpolatedYieldCurveDefinitionMaster" ref="userInterpolatedYieldCurveDefinitionMaster" />
    <property name="userSnapshotMaster" ref="userMarketDataSnapshotMaster" />
  </bean>
  
  <!-- Users Tracker -->
  <bean id="usersTracker" class="com.opengamma.financial.user.DefaultUsersTracker">
    <constructor-arg ref="usersResourceContext"/>
  </bean>

  <!-- User supplied data -->
  <bean id="usersRestBean" class="com.opengamma.financial.user.rest.UsersResource">
    <constructor-arg ref="usersTracker" />
    <constructor-arg ref="usersTracker" />
    <constructor-arg ref="usersResourceContext"/>
  </bean>
  
  <bean id="usersRestBeanCleaner" factory-bean="usersRestBean" factory-method="createDeleteTask">
    <property name="timeout" value="${opengamma.financial-user.timeout}" />
    <property name="scheduler" ref="scheduler" />
  </bean>

  <!-- ============================================================================== -->
  <!-- Distributed component configuration data -->
  <bean id="configurationResource" class="com.opengamma.util.rest.ConfigurationResource">
    <constructor-arg ref="standardFudgeContext" />
    <constructor-arg>
      <map>
        <entry key="0">
          <map>
            <entry key="activeMQ" value="${activeMQ.brokerURL}" />
            <entry key="adHocBatchDbManager">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/adHocBatchDbManager/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="availableOutputs">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/availableOutputs/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="currencyMatrixSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/currencyMatrixSource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="currencyPairsSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/currencyPairsSource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="dependencyGraphBuilder">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/dependencyGraphBuilder/0/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="description" value="Default OpenGamma installation" />
            <entry key="exchangeSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/exchangeSource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="functionRepositoryConfiguration">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/repositoryConfigurationSource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="historicalTimeSeriesMaster">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/historicalTimeSeriesMaster/central/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="historicalTimeSeriesSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/historicalTimeSeriesSource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="holidaySource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/holidaySource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="interpolatedYieldCurveDefinitionSource"> 
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/interpolatedYieldCurveDefinitionSource/combined/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="interpolatedYieldCurveSpecificationBuilder">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/interpolatedYieldCurveSpecificationBuilder/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="marketDataSnapshotMaster">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/marketDataSnapshotMaster/central/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="marketDataSnapshotSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/marketDataSnapshotSource/combined/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="marketDataSnapshotter">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/data/marketDataSnapshotters/Vp~0/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
           <entry key="volatilityCubeDefinitionSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/volatilityCubeDefinitionSource/combined/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="portfolioMaster">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/portfolioMaster/central/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="positionMaster">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/positionMaster/central/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="positionSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/positionSource/combined/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="regionSource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/regionSource/shared/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="remoteCalcNode" value-ref="calcNodeSocketConfig" />
            <entry key="securityMaster">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/securityMaster/combined/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="securitySource">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/components/securitySource/combined/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="userData">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/data/users/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
            <entry key="viewProcessor">
              <bean class="com.opengamma.transport.jaxrs.UriEndPointDescriptionProviderFactoryBean">
                <property name="local" value="/jax/data/viewProcessors/Vp~0/" />
                <property name="port" value="${jetty.port}" />
              </bean>
            </entry>
          </map>
        </entry>
        <!-- THESE ARE FOR CONVENIENT DEBUGGING ONLY; REMOVE WHEN JMX WORK IS DONE -->
         <!-- ENG-154 -->
        <entry key="jobDispatchStatistics" value-ref="jobDispatchStatistics" />
        <entry key="graphExecutionStatistics" value-ref="graphExecutionStatistics" />
        <!-- ENG-240 & ENG-248 -->
        <entry key="executorTuner" value-ref="graphExecutorTuner" />
        <!-- DVI-135; remove when there are remote implementations of all sources -->
        <entry key="DVI-135">
          <bean class="org.springframework.beans.factory.config.PropertiesFactoryBean">
            <property name="location">
              <value>classpath:demoMasters-${opengamma.platform.runmode}.properties</value>
            </property>
          </bean>
        </entry>
      </map>
    </constructor-arg>
  </bean>
  
  <!-- ============================================================================== -->
  <!-- Web -->
  <bean id="webSecuritiesRestBean" class="com.opengamma.web.security.WebSecuritiesResource" scope="request">
    <constructor-arg ref="centralSecurityMaster" />
    <constructor-arg ref="securityLoader"/>
    <constructor-arg ref="centralHistoricalTimeSeriesMaster"/>
    <constructor-arg ref="sharedConfigSource"/>
  </bean>
  <bean id="webPositionsRestBean" class="com.opengamma.web.position.WebPositionsResource" scope="request">
    <constructor-arg ref="centralPositionMaster" />
    <constructor-arg ref="securityLoader"/>
    <constructor-arg ref="sharedSecuritySource"/>
    <constructor-arg ref="centralHistoricalTimeSeriesMaster"/>
    <constructor-arg ref="sharedConfigSource"/>
  </bean>

  <bean id="webTimeSeriesRestBean" class="com.opengamma.web.historicaltimeseries.WebAllHistoricalTimeSeriesResource" scope="request">
    <constructor-arg ref="centralHistoricalTimeSeriesMaster" />
    <constructor-arg ref="htsLoader"/>
  </bean>

  <!-- ============================================================================== -->
  <!-- Bundles RESTful service -->
  <bean id="bundleManager" class="com.opengamma.web.spring.BundleManagerFactoryBean">
    <property name="configResource" value="classpath:${bundle.file}" />
    <property name="baseDir" value="${bundle.basedir}" />
  </bean>
  
  <bean id="yuiCompressorOptions" class="com.opengamma.web.bundle.YUICompressorOptions">
    <property name="lineBreakPosition" value="${yuiCompressorOptions.lineBreakPosition}" />
    <property name="munge" value="${yuiCompressorOptions.munge}" />
    <property name="preserveAllSemiColons" value="${yuiCompressorOptions.preserveAllSemiColons}" />
    <property name="optimize" value="${yuiCompressorOptions.optimize}" />
    <property name="warn" value="${yuiCompressorOptions.warn}" />
  </bean>
  
  <bean id="bundleCompressor" class="com.opengamma.web.bundle.EHCachingBundleCompressor">
    <constructor-arg>
      <bean class="com.opengamma.web.bundle.YUIBundleCompressor">
        <constructor-arg ref="yuiCompressorOptions" />
      </bean>
    </constructor-arg>
    <constructor-arg ref="standardCacheManager" />
  </bean>
  
  <bean id="webBundlesRestBean" class="com.opengamma.web.bundle.WebBundlesResource" scope="request">
    <constructor-arg ref="bundleManager" />
    <constructor-arg ref="bundleCompressor" />
    <constructor-arg value="${bundle.mode}"/>
  </bean>

  <!-- ============================================================================== -->
  <!-- Portfolio aggregators -->
  <bean id="portfolioAggregationFunctions" class="org.springframework.beans.factory.config.ListFactoryBean">
    <property name="sourceList">
      <list>
        <!-- TODO: shared aggregation function config -->
        <bean class="com.opengamma.financial.aggregation.AssetClassAggregationFunction">
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.CurrencyAggregationFunction" />
        <bean class="com.opengamma.financial.aggregation.DetailedAssetClassAggregationFunction" />
        <bean class="com.opengamma.financial.aggregation.RegionAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg ref="sharedRegionSource" />
          <constructor-arg ref="sharedExchangeSource" />
          <constructor-arg value="false" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.UnderlyingAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg value="BLOOMBERG_TICKER" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.GICSAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg value="SECTOR" />
          <constructor-arg value="false" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.GICSAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg value="INDUSTRY_GROUP" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.GICSAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg value="INDUSTRY" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.GICSAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg value="SUB_INDUSTRY" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.EquityBetaAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg ref="sharedHistoricalTimeSeriesSource" />
          <constructor-arg value="false" />
          <constructor-arg value="true" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.CurrentMarketCapAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg ref="sharedHistoricalTimeSeriesSource" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.LiquidityAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg ref="sharedHistoricalTimeSeriesSource" />
          <constructor-arg value="false" />
        </bean>
        <bean class="com.opengamma.financial.aggregation.LongShortAggregationFunction">
          <constructor-arg ref="combinedSecuritySource" />
          <constructor-arg value="false" />
        </bean>
      </list>
    </property>
  </bean>

  <!-- ============================================================================== -->
  <!-- new Web-interface -->
  <bean id="liveResultsService" class="com.opengamma.web.server.push.grid.PushLiveResultsService">
    <constructor-arg ref="demoViewProcessor" />
    <constructor-arg ref="combinedPositionSource" />
    <constructor-arg ref="combinedSecuritySource" />
    <constructor-arg ref="userPortfolioMaster" />
    <constructor-arg ref="userPositionMaster" />
    <constructor-arg ref="userViewDefinitionRepository" />
    <constructor-arg ref="testUser" />
    <constructor-arg ref="standardFudgeContext" />
    <constructor-arg ref="portfolioAggregationFunctions" />
  </bean>

  <bean id="longPollingConnectionManager" class="com.opengamma.web.server.push.LongPollingConnectionManager"/>

  <bean id="connectionManager" class="com.opengamma.web.server.push.ConnectionManagerImpl">
    <constructor-arg index="0" ref="changeManager"/>
    <constructor-arg index="1" ref="masterChangeManager"/>
    <constructor-arg index="2" ref="liveResultsService"/>
    <constructor-arg index="3" ref="longPollingConnectionManager"/>
  </bean>

  <bean id="viewportReportGeneratorFactor" class="com.opengamma.web.server.push.reports.ReportFactory">
    <constructor-arg>
      <map>
        <entry key="csv">
          <bean class="com.opengamma.web.server.push.reports.CsvReportGenerator"/>
        </entry>
      </map>
    </constructor-arg>
  </bean>

  <bean id="webViewportsRestBean" class="com.opengamma.web.server.push.rest.ViewportsResource">
    <constructor-arg index="0" ref="connectionManager"/>
    <constructor-arg index="1" ref="viewportReportGeneratorFactor"/>
  </bean>

  <bean id="changeManager" class="com.opengamma.core.change.AggregatingChangeManager">
    <constructor-arg>
      <list>
        <ref bean="centralPortfolioMaster"/>
        <ref bean="centralPositionMaster"/>
        <!--TODO what other data are we interested in?-->
      </list>
    </constructor-arg>
  </bean>

  <bean id="masterChangeManager" class="com.opengamma.web.server.push.MasterChangeManager">
    <constructor-arg>
      <map>
        <entry key="POSITION" value-ref="centralPositionMaster"/>
        <entry key="PORTFOLIO" value-ref="centralPortfolioMaster"/>
      </map>
    </constructor-arg>
  </bean>

  <bean id="jsonToViewport" class="com.opengamma.web.server.push.rest.ViewportDefinitionMessageBodyReader" scope="singleton"/>

  <bean id="reportToResponseBody" class="com.opengamma.web.server.push.rest.ReportMessageBodyWriter" scope="singleton"/>

  <!-- old Cometd Web-interface -->
  <bean id="webInterfaceBean" class="com.opengamma.web.server.LiveResultsServiceBean">
    <property name="user" ref="testUser" />
    <property name="viewProcessor" ref="demoViewProcessor" />
    <property name="positionSource" ref="combinedPositionSource" />
    <property name="securitySource" ref="combinedSecuritySource" />
    <property name="userPortfolioMaster" ref="userPortfolioMaster" />
    <property name="userPositionMaster" ref="userPositionMaster" />
    <property name="userViewDefinitionRepository" ref="userViewDefinitionRepository" />
    <property name="portfolioAggregators" ref="portfolioAggregationFunctions" />
    <property name="snapshotMaster" ref="centralMarketDataSnapshotMaster" />
    <property name="executorService">
      <bean class="com.opengamma.util.ExecutorServiceFactoryBean">
        <property name="styleName" value="CACHED" />
      </bean>
    </property>
    <property name="fudgeContext" ref="standardFudgeContext" />
  </bean>
  <bean class="com.opengamma.web.analytics.WebAnalyticsResource">
    <constructor-arg ref="webInterfaceBean" />
  </bean>

</beans>
