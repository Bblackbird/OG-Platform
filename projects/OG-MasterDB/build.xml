<project name="og-masterdb" default="compile">
	<property file="build.properties" />

	<import file="${common.dir}/common.xml" />

	<available property="dbscript.create" value="${basedir}/create" file="${basedir}/create-db-common.sql" />
	<target name="dbscript-create-db-sql" if="dbscript.create">
	    <antcall target="create-db-sql-impl-2">
            <param name="dbscript.prefix" value="create" />
	    </antcall>
	</target>
	<available property="dbscript.upgrade" value="${basedir}/upgrade" file="${basedir}/upgrade-db-common.sql" />
	<target name="dbscript-upgrade-db-sql" if="dbscript.upgrade">
        <antcall target="create-db-sql-impl-2">
            <param name="dbscript.prefix" value="upgrade" />
        </antcall>
	</target>
	<target name="create-db-sql-impl" depends="dbscript-create-db-sql,dbscript-upgrade-db-sql" />
	<target name="create-db-sql-impl-2" if="dbscript.prefix">
		<echo>Writing ${basedir}/${dbscript.prefix}-db.sql</echo>
		<concat fixlastline="yes" force="no" destfile="${basedir}/${dbscript.prefix}-db.sql">
			<header filtering="no" trimleading="true">-- IMPORTANT:
			--
			-- This file was generated by concatenating the other .sql files together. It can be
			-- used for testing, but the separate SQL sequences will be necessary if the Security Master
			-- and Position Master need to be installed in different databases.
			--
			-- Please do not modify it - modify the originals and recreate this using 'ant create-db-sql'.

			</header>
			<fileset file="${basedir}/${dbscript.prefix}-db-common.sql" />
            <fileset file="${basedir}/${dbscript.prefix}-db-config.sql" />
            <fileset file="${basedir}/${dbscript.prefix}-db-refdata.sql" />
			<fileset file="${basedir}/${dbscript.prefix}-db-security.sql" />
            <fileset file="${basedir}/${dbscript.prefix}-db-portfolio.sql" />
			<fileset file="${basedir}/${dbscript.prefix}-db-position.sql" />
			<fileset file="${basedir}/${dbscript.prefix}-db-batch.sql" />
			<fileset file="${basedir}/${dbscript.prefix}-db-timeseries.sql" />
			<fileset file="${basedir}/${dbscript.prefix}-db-marketdatasnapshot.sql" />
		</concat>
	</target>
	<target name="create-db-sql" description="--> create a single .sql files from the component ones">
		<delete verbose="true" >
			<fileset dir="${basedir}" includes="**/create-db.sql" />
		</delete>

		<subant target="create-db-sql-impl" genericantfile="${basedir}/build.xml">
			<property name="parent.dir" value="${basedir}" />
			<property name="common.dir" value="${common.dir}" />
            <dirset dir="${install.dir}/db" includes="*/patch_*" />
		</subant>
	</target>
	
	<target name="create-postgres-fin" description="--> run scripts to create database/user/schema/tables for financial db">
			<exec executable="${psql.path}"
		        failonerror="true">
		    	<arg value="--username"/>
				<arg value="postgres"/>
		    	<arg value="--host"/>
		    	<arg value="postgresql-lx-1.hq.opengamma.com"/><!-- todo move server references to a separate properties file -->
		    	<arg value="--file"/>
		    	<arg value="db/postgres/create-og-fin-db-users.sql"/>
				<arg value="--dbname"/>
				<arg value="postgres"/>
		  	</exec>
			<exec executable="${psql.path}"
		        failonerror="true">
		    	<arg value="--username"/>
				<arg value="postgres"/>
		    	<arg value="--host"/>
		    	<arg value="postgresql-lx-1.hq.opengamma.com"/><!-- todo move server references to a separate properties file -->
		    	<arg value="--file"/>
		    	<arg value="db/postgres/create-og-fin-schema.sql"/>
				<arg value="--dbname"/>
				<arg value="og_financial"/>
		  	</exec>
			<exec executable="${psql.path}" failonerror="true">
				<arg value="--username"/>
				<arg value="finowner"/>
		    	<arg value="--host"/>
		    	<arg value="postgresql-lx-1.hq.opengamma.com"/><!-- todo move server references to a separate properties file -->
		    	<arg value="--file"/>
		    	<arg value="db/postgres/create-og-fin-tables.sql"/>
				<arg value="--dbname"/>
				<arg value="og_financial"/>
			</exec>
	</target>
</project>
