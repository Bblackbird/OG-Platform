<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
	"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
	"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping package="com.opengamma.financial.security.db">
  <class name="SecurityBean" abstract="true">
    <!-- these are from SecurityBean -->
    <id name="id">
      <generator class="org.hibernate.id.enhanced.SequenceStyleGenerator"/>
    </id>
    <property name="effectiveDateTime" type="date" not-null="true"/>
    <property name="deleted" type="boolean" not-null="true"/>
    <property name="lastModifiedDateTime" type="date" not-null="true"/>
    <property name="lastModifiedBy" type="string" not-null="false"/>
    <property name="displayName" type="string" not-null="false"/>
    <any name="firstVersion"
         meta-type="string"
	     id-type="long"
	     cascade="save-update">
	    <meta-value value="BOND" class="com.opengamma.financial.security.db.bond.BondSecurityBean" />
	    <meta-value value="EQUITY" class="com.opengamma.financial.security.db.equity.EquitySecurityBean"/>
	    <meta-value value="FUTURE" class="com.opengamma.financial.security.db.future.FutureSecurityBean" />
      <meta-value value="OPTION" class="com.opengamma.financial.security.db.option.OptionSecurityBean" />
	    <!--  insert more subclasses of SecurityBean here -->
	    <!--  note the order is important here -->
	    <column name="first_version_descriminator"/> 
	    <column name="first_version_id"/>
	  </any>
  </class>
  <query name="SecurityBean.one.byUid"><![CDATA[
    select 
      s
    from 
      SecurityBean as s,
      IdentifierAssociationBean as a
    where
      a.security = s.firstVersion and
      (a.validStartDate is null or a.validStartDate <= s.effectiveDateTime) and
      (a.validEndDate is null or a.validEndDate > s.effectiveDateTime) and
      s.id = :securityUid
  ]]></query>
    <!-- NOTE: jim 21-May-2010 - changed effective date tests from < to <= because using dates rather than date times,
       and so it doens't allow you to save something and use it on the same day (!) -->
  <query name="SecurityBean.one.byDateOid"><![CDATA[
    select 
      s
    from 
      IdentifierAssociationBean as a,
      SecurityBean as s
    where
      a.security = s.firstVersion and
      (a.validStartDate is null or a.validStartDate <= :now) and
      (a.validEndDate is null or a.validEndDate > :now) and
      s.firstVersion.id = :securityOid and
      s.effectiveDateTime <= :now and
      not exists (select 
                    latest.id
                  from 
                    SecurityBean as latest
                  where
                    latest.effectiveDateTime <= :now and
                    latest.effectiveDateTime > s.effectiveDateTime and
                    latest.id <> s.id and
                    latest.firstVersion = s.firstVersion)
  ]]></query>
  <!-- note the s, and the 'in (:identifiers)' part of the where -->
  <!-- NOTE: jim 21-May-2010 - changed effective date tests from < to <= because using dates rather than date times,
       and so it doens't allow you to save something and use it on the same day (!) -->
  <query name="SecurityBean.one.byDateIdentifiers"><![CDATA[ 
    select 
      s
    from 
      IdentifierAssociationBean as a,
      SecurityBean as s
    where
      a.security = s.firstVersion and
      (a.validStartDate is null or a.validStartDate <= :now) and
      (a.validEndDate is null or a.validEndDate > :now) and
      a.identifier.scheme = :scheme and
      a.identifier.identifier in (:identifiers) and
      s.effectiveDateTime <= :now and
      not exists (select 
                    latest.id
                  from 
                    SecurityBean as latest
                  where
                    latest.effectiveDateTime <= :now and
                    latest.effectiveDateTime > s.effectiveDateTime and
                    latest.id <> s.id and
                    latest.firstVersion = s.firstVersion)
  ]]></query>
</hibernate-mapping>