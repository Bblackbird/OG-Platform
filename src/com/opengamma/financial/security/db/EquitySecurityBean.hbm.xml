<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
	"-//Hibernate/Hibernate Mapping DTD 3.0//EN"
	"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping package="com.opengamma.financial.security.db">
  <class name="SecurityBean" abstract="true">
    <!-- these are from SecurityBean -->
    <id name="id" column="equities_id">
      <generator class="org.hibernate.id.enhanced.SequenceStyleGenerator"/>
    </id>
    <property name="effectiveDateTime" type="date" not-null="true"/>
    <property name="deleted" type="boolean" not-null="true"/>
    <property name="lastModifiedDateTime" type="date" not-null="true"/>
    <property name="lastModifiedBy" type="string" not-null="false"/>
    <any name="firstVersion"
         meta-type="string"
	     id-type="long"
	     cascade="save-update">
	  <meta-value value="EQUITY" class="EquitySecurityBean"/>
	  <!--  insert more subclasses of SecurityBean here -->
	  <!--  note the order is important here -->
	  <column name="first_version_descriminator"/> 
	  <column name="first_version_id"/>
	</any>
    <union-subclass name="EquitySecurityBean" table="equities">
	    <!--  we'll only ever keep references back to this table here, but we need this for the Hibernate type system so
	          we can match against another security reference -->

	    <!--  these are specific to EquityBean -->
	    <many-to-one name="exchange"
	                 column="exchange_id"
	                 class="ExchangeBean"
	                 not-null="true"/>
	    <property name="companyName" type="string" not-null="true"/>
	    <many-to-one name="currency"
	                 column="currency_id"
	                 class="CurrencyBean"
	                 not-null="true"/>
    </union-subclass>
  </class>
  <!-- queries on this entity -->
  <query name="EquitySecurityBean.all">
    from EquitySecurityBean
  </query>
  <query name="EquitySecurityBean.one.byEffectiveDateTimeExchangeCompanyNameCurrency">
    from 
      EquitySecurityBean as e 
    where 
      e.effectiveDateTime=:effectiveDateTime and
      e.exchange=:exchange and 
      e.companyName=:companyName and 
      e.currency=:currency
  </query>
  <query name="EquitySecurityBean.one.byExchangeCompanyNameCurrencyDate">
    from 
      EquitySecurityBean as e 
    where 
      e.exchange=:exchange and 
      e.companyName=:companyName and 
      e.currency=:currency and
      e.effectiveDateTime &lt;= :now and
      not exists (select 
                    s.id 
                  from 
                    EquitySecurityBean as s
                  where
		  	        s.exchange=:exchange and 
			        s.companyName=:companyName and 
			        s.currency=:currency and
			        s.effectiveDateTime &lt; :now and
			        s.effectiveDateTime &gt; e.effectiveDateTime and 
			        s.id &lt;&gt; e.id)
  </query>
  <query name="EquitySecurityBean.one.byFirstVersionDate">
    from 
      EquitySecurityBean as e 
    where 
      e.firstVersion=:firstVersion and 
      e.effectiveDateTime &lt;= :now and
      not exists (select 
                    s.id 
                  from 
                    EquitySecurityBean as s
                  where
                    s.firstVersion = :firstVersion and
                    s.effectiveDateTime &lt; :now and
                    s.effectiveDateTime &gt; e.effectiveDateTime and
                    s.id &lt;&gt; e.id)  
  </query>
  <query name="EquitySecurityBean.one.liveByExchangeCompanyNameCurrencyDate">
    from 
      EquitySecurityBean as e 
    where 
      e.exchange = :exchange and 
      e.companyName = :companyName and 
      e.currency = :currency and
      e.effectiveDateTime &lt;= :now and
      e.deleted = false and
      not exists (select 
                    s.id 
                  from 
                    EquitySecurityBean as s
                  where
                    s.exchange = :exchange and
                    s.companyName = :companyName and
                    s.currency = :currency and
                    s.effectiveDateTime &lt; :now and
                    s.effectiveDateTime &gt; e.effectiveDateTime and
                    s.id &lt;&gt; e.id)  
  </query>
  <query name="EquitySecurityBean.one.liveByFirstVersionDate">
    from 
      EquitySecurityBean as e 
    where 
      e.firstVersion=:firstVersion and 
      e.deleted=false and
      e.effectiveDateTime &lt;= :now and
      not exists (select 
                    s.id 
                  from 
                    EquitySecurityBean as s
                  where
                    s.firstVersion = :firstVersion and
                    s.deleted = false and
                    s.effectiveDateTime &lt; :now and
                    s.effectiveDateTime &gt; e.effectiveDateTime and
                    s.id &lt;&gt; e.id)  
  </query>
  <query name="EquitySecurityBean.many.allVersionsByFirstVersion">
    from 
      EquitySecurityBean as e 
    where 
      e.firstVersion = :firstVersion
    order by
      e.effectiveDateTime desc
  </query>
</hibernate-mapping>